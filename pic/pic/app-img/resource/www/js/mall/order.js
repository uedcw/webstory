var itemPrice=new Array;var curEditCartId=0;var subCartIn={cart_id:""};var errorNum=0;var errorItem=new Array;var doType=cart.getBuyType();$(function(){if($(".cart_title").length>0){doType=0;cart.setBuyType(doType);$(document).on("click",".select_company_all",function(){var t=$(this).attr("company_id");var e=$(this).prop("checked");$(".cart_item_"+t).prop("checked",e)});$(document).on("click",".select_all",function(){var t=$(this);var e=t.prop("checked");$(".select_company_all").prop("checked",e);$(".cart_item").prop("checked",e);var a=0;if(e){a=1}cart.doAllActive(a,setAllBuyIn)});$(document).on("keyup",".buy_num",function(){var t=$(this).attr("item_in");var e=t.split("_");e["isPack"]=$(this).attr("is_pack");setQuantity(e,0)});$(document).on("blur",".buy_num",function(){var t=$(this).attr("item_in");var e=t.split("_");e["isPack"]=$(this).attr("is_pack");setQuantity(e,1)});$(document).on("click",".del_cart_list_item",function(){var t=$(this);if(confirm("确定要删除此购物车商品吗？")){var e=t.attr("item_in");e+="_"+t.attr("is_pack");delCartItem(e,0,setAllBuyIn)}});$("#write_order_but").click(function(){if(!$(this).hasClass("disable")){checkLogin(function(){$(".remark").each(function(){var t=$(this);var e={};e.remark=t.val();if(e.remark!=""){e.companyId=t.attr("company_id");cart.addCartMark(e)}});location.href="http://"+mallDomain+"/order-step-2.html"})}});$(document).on("click",".del_select_cart_item",function(){var t=0;$(".cart_item_select").each(function(){var e=$(this);if(e.prop("checked")){t++}});if(t>0){if(confirm("确定要删除选中的购物车物品吗？")){$(".cart_item_select").each(function(){var t=$(this);if(t.prop("checked")){var e=t.attr("item_in");e+="_"+t.attr("is_pack");delCartItem(e,0,setAllBuyIn)}})}}else{dialog.error("请选择要删除的物品！")}});$(document).on("click",".cart_item_select",function(){var t=$(this);var e=t.attr("item_in").split("_");var a=$(this).attr("is_pack");var r=0;if(t.prop("checked")){r=1}cart.doItemActive({companyId:e[1],id:e[2],price_id:e[3],purity:e[4],is_pack:a},r,function(){setAllBuyIn();setOrderList()})});$(document).on("click",".select_company_all",function(){var t=$(this);var e=t.attr("company_id");var a=0;if(t.prop("checked")){a=1}cart.doCompanyActive({storeId:e},a,setAllBuyIn)})}else if($(".show_cart_item_title").length>0){if(doType==1){$("#back_step").remove()}var t=new molbaseCheck;t.init();$(document).on("change","#sel_country",function(){var t=$(this).val();$(".area").remove();setArea(t,0)});$(document).on("change","#area_1",function(){var t=$(this).val();var e=$(this).attr("area_num");$("#area_2").remove();setArea(t,e)});$("#pay_but").click(function(){if(!$(this).hasClass("disable")){t.checkAll(subOrder)}})}});function setAllBuyIn(){var t=doType==1?cart.buyCart:cart.cart;$("#all_money").html(toDecimal2(t.goods_price));$("#all_pay_money").html(toDecimal2(t.pay_money));$("#cart_buy_num").html(t.item_active_num);var e=$(".select_all");if(e.length>0){var a=e.prop("checked");if(t.item_active_num==t.item_num){e.prop("checked",true)}else if(a){e.prop("checked",false)}}var r=$("#write_order_but");if(t.goods_price==0){if(r.length>0){r.addClass("disable")}}else{if(r.length>0){r.removeClass("disable")}}}function subOrder(t){checkLogin(function(){var e=mergeArray(t,subCartIn);var a=$("#area_2");if(a.length>0){e["region_id"]=a.val()}else{e["region_id"]=$("#area_1").val()}$("#pay_but").addClass("disable");$("#pay_but").html("订单提交中...");$.ajax({type:"post",url:"http://"+mallDomain+"/ajax_order?do_type=5",data:{sub_data:e},dataType:"json",success:function(t){if(t.code==1){location.href="http://"+mallDomain+"/order-step-3.html"}else{}}})})}function setArea(t,e){$.ajax({type:"post",url:"http://"+mallDomain+"/ajax_region",data:{parent_id:t},dataType:"json",success:function(t){if(t.code==1){var a=null;if(e==0){a=$("#sel_country")}else{a=$("#area_"+e)}e++;var r=$("#area_"+e);if(r.length>0){r.remove()}var i='<select name="area_'+e+'" class="input select area" area_num="'+e+'" id="area_'+e+'" >';for(var c in t.data){i+='<option value="'+t.data[c]["region_id"]+'">'+t.data[c]["region_name"]+"</option>"}i+="</select>";a.after(i);if(e==1){setArea(t.data[0]["region_id"],1)}}}})}function setItemPrice(t,e){if(typeof itemPrice[e[0]]=="undefined"){$.ajax({type:"get",url:"http://"+mallDomain+"/ajax_order?product_id="+t+"&do_type=2",data:{},dataType:"json",success:function(a){if(a.code==1){itemPrice[e[0]]=a.data;setItemBuyIn(t,e)}}})}else{setItemBuyIn(t,e)}}function setItemBuyIn(t,e){var a=$("#buy_num_"+e[1]);var r=a.val();var i=new Array;if(e["isPack"]==1){i=itemPrice[e[0]][e[2]][e[1]]}else{i=getNewPrice(itemPrice[e[0]][e[2]],r)}var c=parseFloat(i[priceType])*parseFloat(r);var s={company:{supplier_company_id:e[4]},item:{id:t,price:i[priceType],quantity:r,purity:i["purity"],goods_price:c,price_id:i["id"],cart_id:e[5],is_pack:e["isPack"]}};if(!e["isPack"]&&e[1]!=i["id"]){a.attr("id","buy_num_"+i["id"]);a.attr("item_in",t+"_"+i["id"]+"_"+e[2]+"_"+e[3]+"_"+e[4]+"_"+e[5])}cart.editItem(s,setAllBuyIn);$("#item_price_"+e[1]).html(i[priceType]);$("#item_money_"+e[1]).html(toDecimal2(c))}function setQuantity(t,e){var a=t[0];var r=$("#buy_num_"+t[1]);var i=r.val();var c=r.attr("min_quantity");var s=r.attr("min_unit");if(i.isInteger()&&i>0){i=parseFloat(i);c=parseFloat(c);if(c>i){if(typeof errorItem["item_"+t[0]]=="undefined"){errorItem["item_"+t[0]]=1;errorNum++}r.css("color","#F00000");$("#write_order_but").addClass("disable");if(e==1){r.css("color","#000000");r.val(c);$("#write_order_but").removeClass("disable");dialog.error("购买数量不能小于"+c+s+"！")}return false}else{if(typeof errorItem["item_"+t[0]]!="undefined"){delete errorItem["item_"+t[0]];errorNum--}setItemPrice(a,t);$("#buy_num_"+t[1]).css("color","#000000");if(errorNum==0){$("#write_order_but").removeClass("disable")}}}else{if(typeof errorItem["item_"+t[0]]=="undefined"){errorItem["item_"+t[0]]=1;errorNum++}$("#write_order_but").addClass("disable");r.css("color","#F00000");if(e==1){dialog.error("购买数量必须为大于0的整数！",function(){r.css("color","#000000");r.val(c);$("#write_order_but").removeClass("disable");r.focus()})}}}function setOrderList(){if(cart.cart.is_active){$(".select_all").prop("checked",true)}var t="";for(var e in cart.cart.item){var a=cart.cart.item[e]["company"];var r=a["is_active"]?"checked":"";var i=$("#company_"+a["supplier_company_id"]);if(i.length>0){i.remove();$("#company_product_"+a["supplier_company_id"]).remove()}$("#company_"+a["supplier_company_id"]).remove();t+='<tr class="company" id="company_'+a["supplier_company_id"]+'"><td colspan="7">'+'<input type="checkbox" name="company" '+r+' class="select_company_all" company_id="'+a["supplier_company_id"]+'"'+'value="'+a["supplier_company_id"]+'"/> '+a["supplier_company"]+"</td></tr>"+'<tr id="company_product_'+a["supplier_company_id"]+'"><td colspan="7">'+'<table class="product_item">';for(var c in cart.cart.item[e]["itemList"]){var s=cart.cart.item[e]["itemList"][c];var n=s["is_active"]?"checked":"";t+='<tr id="item_'+s["id"]+"_"+s["price_id"]+'" class="per_item_'+a["supplier_company_id"]+'">'+'<td class="select" ><input type="checkbox" '+n+' name="cart_item" value="1"  is_pack="'+s["is_pack"]+'" class="cart_item cart_item_select cart_item_'+a["supplier_company_id"]+'" item_in="'+e+"_"+s["id"]+"_"+s["price_id"]+"_"+s["purity"]+'" /></td>'+'<td class="product_in"> <div class="img_form"><a href="http://'+mallDomain+"/goods-"+s["id"]+'.html" title="" class="img_link"><img src="'+s["img"]+'" /></a></div>'+'<div class="product_des">'+'<a href="http://'+mallDomain+"/goods-"+s["id"]+'.html" title="'+s["name"]+'">'+s["name"].subStr(80)+"</a>"+(s["cas_no"]!=""?"<span>("+s["cas_no"]+")</span>":"")+"</div></td>"+'<td><span id="item_purity_'+s["id"]+'">'+s["purity"]+"</span></td>"+'<td class="add_num"><input type="text" name="item_quantity" min_unit="'+s["base_unit"]+'" min_quantity="'+s["min_quantity"]+'" value="'+s["quantity"]+'" style="width:30px;" class="buy_num"'+' id="buy_num_'+s["price_id"]+'" is_pack="'+s["is_pack"]+'" item_in="'+s["id"]+"_"+s["price_id"]+"_"+s["purity"]+"_"+e+"_"+s["cart_id"]+'" /><span>'+s["base_unit"]+"</span></td>"+'<td ><span class="number" >￥<span id="item_price_'+s["price_id"]+'">'+s["price"]+"</span></span>"+(s["is_pack"]==1?"":"")+"/"+s["base_unit"]+"</td>"+'<td><span class="number">'+(priceType=="price_rmb"?"￥":"$")+'<span id="item_money_'+s["price_id"]+'">'+s["goods_price"]+"</span></span></td>"+'<td class="do">'+'<!--<a href="javascript:;" class="handle">收藏</a>-->'+'<a href="javascript:;" class="handle del_cart_list_item" item_in="'+e+"_"+s["id"]+"_"+s["price_id"]+"_"+s["purity"]+'" is_pack="'+s["is_pack"]+'">删除</a>'+"</td></tr>"}t+='<tr id="company_remark_'+a["supplier_company_id"]+'"><td colspan="7">'+'<input type="text" value="" placeholder="补充说明信息" class="remark" company_id="'+a["supplier_company_id"]+'" id="cart_remark_'+a["supplier_company_id"]+'"/>'+"</td></tr></table> </td></tr>"}cart.resetCart(setAllBuyIn);$(".cart_title").after(t)}function showOrderList(){var t="";var e=doType==1?cart.buyCart.item:cart.cart.item;for(var a in e){var r=e[a]["company"];var i="";i+='<tr class="company"><td colspan="7">'+r["supplier_company"]+"</td></tr>"+'<tr><td colspan="7"><table class="product_item">';if(typeof cart.cartRemark[a]!="undefined"){subCartIn["remark_"+r["supplier_company_id"]]=cart.cartRemark[a]["remark"]}var c=0;for(var s in e[a]["itemList"]){var n=e[a]["itemList"][s];if(n["is_active"]==1){subCartIn["cart_id"]+=","+n["cart_id"];i+='<tr> <td class="product_in">'+'<div class="img_form show"><a href="http://'+mallDomain+"/goods-"+n["id"]+'.html" title="" class="img_link"><img src="'+n["img"]+'" /></a></div>'+'<div class="product_des"><a href="http://'+mallDomain+"/goods-"+n["id"]+'.html" title="'+n["name"]+'">'+n["name"].subStr(80)+"</a>"+(n["cas_no"]!=""?"<span>("+n["cas_no"]+")</span>":"")+"</div></td>"+"<td>"+n["purity"]+"</td><td>"+n["quantity"]+""+n["base_unit"]+"</td>"+'<td><span class="number">'+n["price"]+"</span>"+(n["is_pack"]==1?"":"")+"/"+n["base_unit"]+"</td>"+'<td><span class="number">'+(priceType=="price_rmb"?"￥":"$")+n["goods_price"]+"</span></td>"+'<td><span class="number">'+n["lead_time"]+"</span>天 </td></tr>";c=1}}if(typeof cart.cartRemark[a]!="undefined"){i+='<tr class="product_mark_tr"> <td colspan="6"><sapn class="product_mark">备注：'+cart.cartRemark[a]["remark"]+"</sapn></td></tr>"}i+="</table></td></tr>";if(c===1){t+=i}}setAllBuyIn();$(".show_cart_item_title").after(t)}