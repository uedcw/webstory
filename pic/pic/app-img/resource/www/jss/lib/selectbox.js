define(["jquery","popup"],function(e,t){function n(t,n){t=this.select=e(t),e.extend(this,n||{});var r=this,i=!("minWidth"in t[0].style);if(t.is("[multiple]"))return;t.data("selectbox")&&t.data("selectbox").remove();var s=this._tpl(this.selectboxHtml,e.extend({textContent:r._getOption().html()||""},t.data()));this._selectbox=e(s),this._value=this._selectbox.find("[data-value]"),this.isShowDropdown&&!t.attr("disabled")&&(this._globalKeydown=e.proxy(this._globalKeydown,this),this._selectbox.on(this._clickType+" focus blur",function(e){r[r._clickType===e.type?"click":e.type]()})),this._selectbox.css({width:t.outerWidth()+"px"}),t.on("focus blur",function(e){r[e.type](),e.preventDefault()}).on("change",function(){var e=r._getOption().html();r._value.html(e)}),t.css({opacity:0,position:"absolute",left:i?"-9999px":"auto",right:"auto",top:"auto",bottom:"auto",zIndex:this.isShowDropdown?-1:1}).data("selectbox",this),t.after(this._selectbox)}var r=function(){};return r.prototype=t.prototype,n.prototype=new r,e.extend(n.prototype,{selectboxHtml:'<div class="ui-selectbox" hidefocus="true" style="user-select:none" onselectstart="return false" tabindex="-1" aria-hidden><div class="ui-selectbox-inner" data-value="">{{textContent}}</div><i class="ui-selectbox-icon"></i></div>',dropdownHtml:'<dl class="ui-selectbox-dropdown">{{options}}</dl>',optgroupHtml:'<dt class="ui-selectbox-optgroup">{{label}}</dt>',optionHtml:'<dd class="ui-selectbox-option {{className}}" data-option="{{index}}" tabindex="-1">{{textContent}}</dd>',selectedClass:"ui-selectbox-selected",disabledClass:"ui-selectbox-disabled",focusClass:"ui-selectbox-focus",openClass:"ui-selectbox-open",isShowDropdown:!("createTouch"in document),selectedIndex:0,value:"",close:function(){this._popup&&(this._popup.close().remove(),this.change())},show:function(){var n=this,r=this.select,i=n._selectbox;if(!r[0].length)return!1;var s=20,o=r.outerHeight(),u=r.offset().top-e(document).scrollTop(),a=e(window).height()-u-o,f=Math.max(u,a)-s,l=this._popup=new t;l.node.innerHTML=this._dropdownHtml(),this._dropdown=e(l.node),e(l.backdrop).css("opacity",0).on(this._clickType,e.proxy(this.close,this));var c=n._dropdown.children(),h=!("minWidth"in c[0].style);c.css({minWidth:i.innerWidth(),maxHeight:f,overflowY:"auto",overflowX:"hidden"}),this._dropdown.on(this._clickType,"[data-option]",function(t){var r=e(this).data("option");n.selected(r),n.close(),t.preventDefault()}),l.onshow=function(){e(document).on("keydown",n._globalKeydown),i.addClass(n.openClass),n.selectedIndex=r[0].selectedIndex,n.selected(n.selectedIndex)},l.onremove=function(){e(document).off("keydown",n._globalKeydown),i.removeClass(n.openClass)},this._oldValue=this.select.val(),l.showModal(i[0]),h&&(c.css({width:Math.max(i.innerWidth(),c.outerWidth()),height:Math.min(f,c.outerHeight())}),l.reset())},selected:function(e){if(this._getOption(e).attr("disabled"))return!1;var t=this._dropdown,n=this._dropdown.find("[data-option="+e+"]"),r=this.select[0].options[e].value,i=this.select[0].selectedIndex,s=this.selectedClass;return t.find("[data-option="+i+"]").removeClass(s),n.addClass(s),n.focus(),this._value.html(this._getOption(e).html()),this.value=r,this.selectedIndex=e,this.select[0].selectedIndex=this.selectedIndex,this.select[0].value=this.value,!0},change:function(){this._oldValue!==this.value&&this.select.triggerHandler("change")},click:function(){this.select.focus(),this._popup&&this._popup.open?this.close():this.show()},focus:function(){this._selectbox.addClass(this.focusClass)},blur:function(){this._selectbox.removeClass(this.focusClass)},remove:function(){this.close(),this._selectbox.remove()},_clickType:"onmousedown"in document?"mousedown":"touchstart",_getOption:function(e){return e=e===undefined?this.select[0].selectedIndex:e,this.select.find("option").eq(e)},_tpl:function(e,t){return e.replace(/{{(.*?)}}/g,function(e,n){return t[n]})},_dropdownHtml:function(){var t="",n=this,r=this.select,i=r.data(),s=0,o=function(r){r.each(function(){var r=e(this),o="";this.selected?o=n.selectedClass:o=this.disabled?n.disabledClass:"",t+=n._tpl(n.optionHtml,e.extend({value:r.val(),textContent:r.html(),index:s,className:o},r.data(),i)),s++})};return r.find("optgroup").length?r.find("optgroup").each(function(r){t+=n._tpl(n.optgroupHtml,e.extend({index:r,label:this.label},e(this).data(),i)),o(e(this).find("option"))}):o(r.find("option")),this._tpl(this.dropdownHtml,{options:t})},_move:function(e){var t=0,n=this.select[0].length-1,r=this.select[0].selectedIndex+e;r>=t&&r<=n&&(this.selected(r)||this._move(e+e))},_globalKeydown:function(e){var t;switch(e.keyCode){case 8:t=!0;break;case 9:case 27:case 13:this.close(),t=!0;break;case 38:this._move(-1),t=!0;break;case 40:this._move(1),t=!0}t&&e.preventDefault()}}),function(t,r){t.type==="select"?new n(t,r):e(t).each(function(){new n(this,r)})}});